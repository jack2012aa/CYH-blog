<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>[CS 5204 Operating Systems Project 2] XV6 File System Checker - CYH Blog</title>
<meta name=theme-color><meta name=description content="Link
What it does.
xcheck is a file system checker designed for the xv6 operating system. It checks 11 types of consistency:

Superblock consistency.
Root directory existence.
Inode type.
Direct and indirect addresses validity.
Direct and indirect addresses reference counts.
Directory entries validity (existence of &ldquo;.&rdquo; and &ldquo;..&rdquo; entries).
Data bitmap consistency.
Files reference counts.
In-use inodes reference in directory entries.
Referred inode allocation state.
Directory reference counts.

How it works
Structure
.
├── fs.img        # File system image for testing
├── Makefile      # Makefile
├── README.md     # Readme
├── src
│   ├── bitmap.c  # A flexible size bitmap class used to read / build fs bitmap.
│   ├── bitmap.h
│   ├── check.c   # The check function
│   ├── check.h
│   ├── test.c    # A test for the check function
│   └── xcheck.c  # The main function
└── xv6-riscv     # xv6 source code
Bitmap
bitmap.h defines a bitmap structure which is based on an array of unsigned integer. bitmap_init takes an variable size and allocate memory for the array, and bitmap_set tests and sets a specific bit in the bitmap."><meta name=author content="Chang-Yu Huang"><link rel="preload stylesheet" as=style href=https://jack2012aa.github.io/CYH-blog/main.min.css><link rel=preload as=image href=https://jack2012aa.github.io/CYH-blog/theme.png><link rel=preload as=image href=img/oct.JPG><link rel=preload as=image href=https://jack2012aa.github.io/CYH-blog/github.svg><script defer src=https://jack2012aa.github.io/CYH-blog/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jack2012aa.github.io/CYH-blog/img/cloud.JPG><link rel=apple-touch-icon href=https://jack2012aa.github.io/CYH-blog/apple-touch-icon.png><meta name=generator content="Hugo 0.139.3"><meta itemprop=name content="[CS 5204 Operating Systems Project 2] XV6 File System Checker"><meta itemprop=description content="Link What it does. xcheck is a file system checker designed for the xv6 operating system. It checks 11 types of consistency:
Superblock consistency. Root directory existence. Inode type. Direct and indirect addresses validity. Direct and indirect addresses reference counts. Directory entries validity (existence of “.” and “..” entries). Data bitmap consistency. Files reference counts. In-use inodes reference in directory entries. Referred inode allocation state. Directory reference counts. How it works Structure . ├── fs.img # File system image for testing ├── Makefile # Makefile ├── README.md # Readme ├── src │ ├── bitmap.c # A flexible size bitmap class used to read / build fs bitmap. │ ├── bitmap.h │ ├── check.c # The check function │ ├── check.h │ ├── test.c # A test for the check function │ └── xcheck.c # The main function └── xv6-riscv # xv6 source code Bitmap bitmap.h defines a bitmap structure which is based on an array of unsigned integer. bitmap_init takes an variable size and allocate memory for the array, and bitmap_set tests and sets a specific bit in the bitmap."><meta itemprop=datePublished content="2025-07-07T18:03:01+08:00"><meta itemprop=dateModified content="2025-07-07T18:03:01+08:00"><meta itemprop=wordCount content="611"><meta itemprop=keywords content="C,Operating Systems"><meta property="og:url" content="https://jack2012aa.github.io/CYH-blog/posts/cs-5204/cs-5204-p2/"><meta property="og:site_name" content="CYH Blog"><meta property="og:title" content="[CS 5204 Operating Systems Project 2] XV6 File System Checker"><meta property="og:description" content="Link What it does. xcheck is a file system checker designed for the xv6 operating system. It checks 11 types of consistency:
Superblock consistency. Root directory existence. Inode type. Direct and indirect addresses validity. Direct and indirect addresses reference counts. Directory entries validity (existence of “.” and “..” entries). Data bitmap consistency. Files reference counts. In-use inodes reference in directory entries. Referred inode allocation state. Directory reference counts. How it works Structure . ├── fs.img # File system image for testing ├── Makefile # Makefile ├── README.md # Readme ├── src │ ├── bitmap.c # A flexible size bitmap class used to read / build fs bitmap. │ ├── bitmap.h │ ├── check.c # The check function │ ├── check.h │ ├── test.c # A test for the check function │ └── xcheck.c # The main function └── xv6-riscv # xv6 source code Bitmap bitmap.h defines a bitmap structure which is based on an array of unsigned integer. bitmap_init takes an variable size and allocate memory for the array, and bitmap_set tests and sets a specific bit in the bitmap."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-07T18:03:01+08:00"><meta property="article:modified_time" content="2025-07-07T18:03:01+08:00"><meta property="article:tag" content="C"><meta property="article:tag" content="Operating Systems"><meta name=twitter:card content="summary"><meta name=twitter:title content="[CS 5204 Operating Systems Project 2] XV6 File System Checker"><meta name=twitter:description content="Link What it does. xcheck is a file system checker designed for the xv6 operating system. It checks 11 types of consistency:
Superblock consistency. Root directory existence. Inode type. Direct and indirect addresses validity. Direct and indirect addresses reference counts. Directory entries validity (existence of “.” and “..” entries). Data bitmap consistency. Files reference counts. In-use inodes reference in directory entries. Referred inode allocation state. Directory reference counts. How it works Structure . ├── fs.img # File system image for testing ├── Makefile # Makefile ├── README.md # Readme ├── src │ ├── bitmap.c # A flexible size bitmap class used to read / build fs bitmap. │ ├── bitmap.h │ ├── check.c # The check function │ ├── check.h │ ├── test.c # A test for the check function │ └── xcheck.c # The main function └── xv6-riscv # xv6 source code Bitmap bitmap.h defines a bitmap structure which is based on an array of unsigned integer. bitmap_init takes an variable size and allocate memory for the array, and bitmap_set tests and sets a specific bit in the bitmap."><link rel=canonical href=https://jack2012aa.github.io/CYH-blog/posts/cs-5204/cs-5204-p2/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center"><div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center"><a class="-translate-y-[1px] text-2xl font-medium" href=https://jack2012aa.github.io/CYH-blog/>CYH Blog</a><div class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/CYH-blog/about/>About</a>
<a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/CYH-blog/categories/courseworks/>Courseworks</a>
<a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/CYH-blog/categories/sideprojects/>Side Projects</a></nav><nav class="mt-12 flex justify-center space-x-10 rtl:space-x-reverse dark:invert ltr:lg:ml-14 rtl:lg:mr-14 lg:mt-0 lg:items-center"><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/jack2012aa target=_blank rel=me>github</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100vh-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"><article><header class=mb-14><h1 class="!my-0 pb-2.5">[CS 5204 Operating Systems Project 2] XV6 File System Checker</h1><div class="text-xs antialiased opacity-60"><time>Jul 7, 2025</time></div></header><section><h3 id=linkhttpsgithubcomjack2012aacs5204-spring25-p2><a href=https://github.com/jack2012aa/CS5204-Spring25-P2>Link</a></h3><h2 id=what-it-does>What it does.</h2><p><code>xcheck</code> is a file system checker designed for the xv6 operating system. It checks 11 types of consistency:</p><ol><li>Superblock consistency.</li><li>Root directory existence.</li><li>Inode type.</li><li>Direct and indirect addresses validity.</li><li>Direct and indirect addresses reference counts.</li><li>Directory entries validity (existence of &ldquo;.&rdquo; and &ldquo;..&rdquo; entries).</li><li>Data bitmap consistency.</li><li>Files reference counts.</li><li>In-use inodes reference in directory entries.</li><li>Referred inode allocation state.</li><li>Directory reference counts.</li></ol><h2 id=how-it-works>How it works</h2><h3 id=structure>Structure</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── fs.img        <span style=color:#75715e># File system image for testing</span>
</span></span><span style=display:flex><span>├── Makefile      <span style=color:#75715e># Makefile</span>
</span></span><span style=display:flex><span>├── README.md     <span style=color:#75715e># Readme</span>
</span></span><span style=display:flex><span>├── src
</span></span><span style=display:flex><span>│   ├── bitmap.c  <span style=color:#75715e># A flexible size bitmap class used to read / build fs bitmap.</span>
</span></span><span style=display:flex><span>│   ├── bitmap.h
</span></span><span style=display:flex><span>│   ├── check.c   <span style=color:#75715e># The check function</span>
</span></span><span style=display:flex><span>│   ├── check.h
</span></span><span style=display:flex><span>│   ├── test.c    <span style=color:#75715e># A test for the check function</span>
</span></span><span style=display:flex><span>│   └── xcheck.c  <span style=color:#75715e># The main function</span>
</span></span><span style=display:flex><span>└── xv6-riscv     <span style=color:#75715e># xv6 source code</span>
</span></span></code></pre></div><h3 id=bitmap>Bitmap</h3><p><code>bitmap.h</code> defines a bitmap structure which is based on an array of unsigned integer. <code>bitmap_init</code> takes an variable size and allocate memory for the array, and <code>bitmap_set</code> tests and sets a specific bit in the bitmap.</p><h3 id=check>Check</h3><p><code>check.c</code> defines a helper function <code>convert_inode_to_address</code> that convert an inumber to the real address of the inode in the memory, and the main check function <code>check</code>.</p><p>Generally, <code>check</code> :</p><ol><li>maps the file system to memory,</li><li>checks the superblock,</li><li>uses a for loop to read through and check every inode and dirent structures,</li><li>compares bitmaps built during the previous traversal,</li><li>uses another for loop to check file and directory reference counts.</li></ol><p>Although combining different checks in two for loop is ugly, it reduces required I/O and hence increase performance (if the image is large).</p><p>Below are strategies for checking each type of consistency:</p><h4 id=superblock-consistency>Superblock consistency</h4><ul><li>Comparing attributes with constraints (such as <code>superblock.magic</code>) or calculated value (such as <code>superblock.size</code>).</li></ul><h4 id=root-directory-existence>Root directory existence</h4><ul><li>Reading the root inode and checking its type.</li></ul><h4 id=inode-type>Inode type</h4><ul><li>Checking the inode type in the first loop.</li></ul><h4 id=direct-and-indirect-addresses-validity>Direct and indirect addresses validity</h4><ul><li>Checking the bound of the address in the first loop.</li></ul><h4 id=direct-and-indirect-addresses-reference-counts>Direct and indirect addresses reference counts</h4><ul><li>Using a bitmap that marks visited block number and checking in the first loop.</li></ul><h4 id=directory-entries-validity-existence-of--and--entries>Directory entries validity (existence of &ldquo;.&rdquo; and &ldquo;..&rdquo; entries)</h4><ul><li>Reading every direct and indirect addresses into an array and traversing the array to find those entries in the first loop.</li></ul><h4 id=data-bitmap-consistency>Data bitmap consistency</h4><ul><li>Comparing the bitmap built during reading direct and indirect addresses to file system&rsquo;s bitmap.</li></ul><h4 id=files-reference-counts>Files reference counts</h4><ul><li>Building an array of reference counts of inodes in the first loop, and comparing the reference counts array with the inode reference count in the second loop.</li></ul><h4 id=in-use-inodes-reference-in-directory-entries>In-use inodes reference in directory entries</h4><ul><li>Building a bitmap for in-use inodes and a bitmap for referred bitmap. If the first bitmap > the second bitmap then there is a in-use inode that is not referred.</li></ul><h4 id=referred-inode-allocation-state>Referred inode allocation state.</h4><ul><li>Similar with the previous one.</li></ul><h4 id=directory-reference-counts>Directory reference counts.</h4><ul><li>Checking the array of reference counts of inodes that every directory inode mush have only one reference count in the second loop.</li></ul><h3 id=xcheck>xcheck</h3><p><code>xcheck.c</code> only includes a main function that accepts the image path, maps it to memory, and calls <code>check</code> and checks its return value.</p><h3 id=test>Test</h3><p><code>test.c</code> defines tests for all consistency checks. It reads a consistent file system image, maps it to the memory, and modify value in specific address to generate a mutate image and pass it to the <code>check</code> function.</p><p>The file system passed to <code>test</code> should be as empty as possible to get a correct result.</p><h2 id=how-it-is-uesd>How it is uesd</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Compile the code.</span>
</span></span><span style=display:flex><span>make clean
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run checker.</span>
</span></span><span style=display:flex><span>./xcheck &lt;file system image&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Test the checker.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Use a consistent image.</span>
</span></span><span style=display:flex><span>./test &lt;file system image&gt;
</span></span></code></pre></div></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]" href=https://jack2012aa.github.io/CYH-blog/tags/c>C</a>
<a class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]" href=https://jack2012aa.github.io/CYH-blog/tags/operating-systems>Operating Systems</a></footer><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://jack2012aa.github.io/CYH-blog/posts/syntaxnext/1-intro/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>[SyntaxNext] Project Introduction</span></a>
<a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href=https://jack2012aa.github.io/CYH-blog/posts/cs-5204/cs-5204-p1/><span>[CS 5204 Operating Systems Project 1] Multi-thread Web Server</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav></article></main><footer class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"><div class=mr-auto>&copy; 2025
<a class=link href=https://jack2012aa.github.io/CYH-blog/>CYH Blog</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>hugo-paper</a></footer></body></html>